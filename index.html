<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TON Spin Demo</title>
  <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <h2>Spin the Wheel</h2>
  <div id="connect-root"></div>
  <button id="payBtn" disabled>Pay 0.0001 TON & Get Spin</button>
  <button id="spinBtn" disabled>üé° Spin Now</button>
  <div id="spinsLeft"></div>
  <div id="result"></div>

  <script>
    const BACKEND_URL = "http://localhost:3000"; // ’Ø’°’¥ production URL
    const RECEIVER = "UQBfrU75WGhBLnRpBs1ImWE5sPdxKsFMBgogpD578JxXyDbK";
    const AMOUNT = 100000;

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://haykoo707.github.io/test-payment/tonconnect-manifest.json",
      buttonRootId: "connect-root",
      uiPreferences: { theme: "SYSTEM" }
    });

    let spins = parseInt(localStorage.getItem("spins") || "0");
    const payBtn = document.getElementById("payBtn");
    const spinBtn = document.getElementById("spinBtn");
    const resultEl = document.getElementById("result");
    const spinsEl = document.getElementById("spinsLeft");

    function updateSpins() {
      spinsEl.innerText = `Spins left: ${spins}`;
      spinBtn.disabled = spins <= 0;
      payBtn.disabled = !tonConnectUI.account;
    }
    updateSpins();

    tonConnectUI.connectionRestored.then(updateSpins);

    payBtn.addEventListener("click", async () => {
      try {
        const tx = {
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [{ address: RECEIVER, amount: AMOUNT.toString() }]
        };
        const sendRes = await tonConnectUI.sendTransaction(tx);
        const txHash = sendRes?.hash;

        if (!txHash) {
          resultEl.innerText = "‚ùå Wallet did not return txHash!";
          return;
        }

        const res = await fetch(`${BACKEND_URL}/check-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ txHash })
        });
        const data = await res.json();

        if (data.success) {
          spins++;
          localStorage.setItem("spins", spins);
          updateSpins();
          resultEl.innerText = "‚úÖ Payment verified! 1 spin added!";
          spinBtn.disabled = false;
        } else {
          resultEl.innerText = "‚ùå Payment not verified!";
        }
      } catch (err) {
        console.error(err);
        resultEl.innerText = "‚ùå Payment cancelled or failed!";
      }
    });

    spinBtn.addEventListener("click", () => {
      if (spins > 0) {
        spins--;
        localStorage.setItem("spins", spins);
        updateSpins();
        alert("üé° Wheel is spinning...");
      } else {
        alert("‚ùå You don‚Äôt have spins left!");
      }
    });
  </script>
</body>
</html>
